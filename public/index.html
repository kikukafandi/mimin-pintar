<!DOCTYPE html>
<html>
<head>
    <title>Mimin Pintar Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: white; padding: 20px; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 20px; display: flex; flex-direction: column; }
        
        .status-box { padding: 15px; border-radius: 8px; text-align: center; color: white; font-weight: bold; margin-bottom: 20px;}
        .connected { background: #25D366; }
        .disconnected { background: #ff4b4b; }
        
        #chat-container { flex: 1; overflow-y: auto; padding-right: 10px; }
        .chat-bubble { background: white; padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; max-width: 80%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sender { font-weight: bold; color: #075E54; font-size: 0.9em; margin-bottom: 4px; }
        .time { font-size: 0.7em; color: #888; text-align: right; margin-top: 4px; }
        
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;}
        button { width: 100%; padding: 10px; background: #0084ff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #006bcf; }
        canvas { width: 100% !important; height: auto !important; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>ü§ñ Status Bot</h2>
        <div id="status" class="status-box disconnected">Mencari Koneksi...</div>
        
        <div id="qr-container" style="display: none; text-align: center;">
            <p>Scan QR di HP:</p>
            <canvas id="qr-canvas"></canvas>
        </div>

        <div style="margin-top: auto;">
            <h3>‚öôÔ∏è Konfigurasi</h3>
            <input type="password" id="apiKey" placeholder="Google API Key">
            <textarea id="knowledge" rows="5" placeholder="Info Toko / Produk..."></textarea>
            <button onclick="saveConfig()">Simpan & Jalankan</button>
        </div>
    </div>

    <div class="main">
        <h2>üí¨ Live Chat Masuk</h2>
        <div id="chat-container">
            </div>
    </div>

    <script>
        // Load Config Awal (Fetch ke Internal Express)
        fetch('http://localhost:3000/api/config').then(r=>r.json()).then(data => {
            if(data.apiKey) document.getElementById('apiKey').value = data.apiKey;
            if(data.knowledge) document.getElementById('knowledge').value = data.knowledge;
        });

        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const knowledge = document.getElementById('knowledge').value;
            fetch('http://localhost:3000/api/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apiKey, knowledge })
            }).then(() => alert('Bot Dijalankan!'));
        }

        // --- ELECTRON IPC HANDLERS ---
        if (window.electronAPI) {
            window.electronAPI.onUpdateStatus((status) => {
                const el = document.getElementById('status');
                if (status === 'CONNECTED') {
                    el.innerText = "TERHUBUNG ‚úÖ";
                    el.className = "status-box connected";
                    document.getElementById('qr-container').style.display = "none";
                } else {
                    el.innerText = "TERPUTUS ‚ùå";
                    el.className = "status-box disconnected";
                }
            });

            window.electronAPI.onUpdateQR((qrString) => {
                document.getElementById('qr-container').style.display = "block";
                QRCode.toCanvas(document.getElementById('qr-canvas'), qrString, function (error) { if (error) console.error(error) });
            });

            window.electronAPI.onNewMessage((msg) => {
                const container = document.getElementById('chat-container');
                const html = `
                    <div class="chat-bubble">
                        <div class="sender">${msg.sender}</div>
                        <div>${msg.text}</div>
                        <div class="time">${msg.time}</div>
                    </div>`;
                container.insertAdjacentHTML('afterbegin', html);
            });
        }
    </script>
</body>
</html>